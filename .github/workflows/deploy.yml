name: Deploy to Production

# Trigger: Jalan setiap kali ada push ke branch production
on:
  push:
    branches: [ production ]

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    
    steps:
    - name: Executing remote ssh commands
      # Kita menggunakan action pihak ketiga yang populer untuk SSH
      uses: appleboy/ssh-action@v1.0.0
      # ... (bagian atas sama) ...
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        script: |
          export PNPM_HOME="/home/daylight/.local/share/pnpm"
          export PATH="$PNPM_HOME:$PATH"

          # Cek versi dulu untuk memastikan pnpm sudah terbaca
          echo "Node version: $(node -v)"
          echo "PNPM version: $(pnpm -v)"

          cd daylight
          git pull origin production

          # --- BACKEND SETUP ---
          echo "üöÄ Starting Backend Build..."
          cd backend-daylight
          pnpm install            
          pnpm prisma generate     
          
          echo "üóÑÔ∏è Migrating Database..."
          pnpm prisma migrate deploy

          pnpm build
          cd ..

          # --- FRONTEND SETUP ---
          echo "üöÄ Starting Frontend Build..."
          cd frontend-daylight
          pnpm install
          pnpm build
          cd ..

          # --- RESTART SERVICES ---
          echo "üîÑ Restarting PM2..."
          pm2 restart all
          pm2 save
          
          echo "‚úÖ Deployment Success!"