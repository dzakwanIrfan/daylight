generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum AuthProvider {
  LOCAL
  GOOGLE
}

enum UserRole {
  USER
  ADMIN
}

enum RelationshipStatus {
  SINGLE
  MARRIED
  PREFER_NOT_SAY
}

enum GenderMixComfort {
  TOTALLY_FINE
  PREFER_SAME_GENDER
  DEPENDS
}

enum PersonalityArchetype {
  BRIGHT_MORNING
  CALM_DAWN
  BOLD_NOON
  GOLDEN_HOUR
  QUIET_DUSK
  CLOUDY_DAY
  SERENE_DRIZZLE
  BLAZING_NOON
  STARRY_NIGHT
  PERFECT_DAY
}

model User {
  id                String            @id @default(uuid())
  email             String            @unique
  password          String?
  firstName         String?
  lastName          String?
  phoneNumber       String?
  profilePicture    String?
  role              UserRole          @default(USER)
  provider          AuthProvider      @default(LOCAL)
  googleId          String?           @unique
  isEmailVerified   Boolean           @default(false)
  isActive          Boolean           @default(true)
  
  // Email verification - HASHED TOKEN
  emailVerificationTokenHash   String?   @unique
  emailVerificationExpires     DateTime?
  
  // Password reset - HASHED TOKEN
  resetPasswordTokenHash       String?   @unique
  resetPasswordExpires         DateTime?
  
  // Refresh token version for revocation
  refreshTokenVersion          Int       @default(0)
  
  personalityResult            PersonalityResult?
  refreshTokens                RefreshToken[]
  
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  
  @@index([email])
  @@index([googleId])
  @@index([role])
  @@index([isActive])
  @@index([emailVerificationTokenHash])
  @@index([resetPasswordTokenHash])
}

// Token blacklist for refresh tokens
model RefreshToken {
  id           String   @id @default(uuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tokenHash    String   @unique
  isRevoked    Boolean  @default(false)
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  
  @@index([userId])
  @@index([tokenHash])
  @@index([expiresAt])
}

model PersonalityResult {
  id                    String                @id @default(uuid())
  userId                String?               @unique
  user                  User?                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  sessionId             String?               @unique
  
  energyRaw             Float
  opennessRaw           Float
  structureRaw          Float
  affectRaw             Float
  comfortRaw            Float
  lifestyleRaw          Float
  
  energyScore           Float
  opennessScore         Float
  structureScore        Float
  affectScore           Float
  comfortScore          Float
  lifestyleScore        Float
  
  profileScore          Float
  archetype             PersonalityArchetype
  
  relationshipStatus    RelationshipStatus?
  intentOnDaylight      String[]
  genderMixComfort      GenderMixComfort?
  
  answers               Json
  
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  
  @@index([sessionId])
  @@index([userId])
}

model Question {
  id                    String                @id @default(uuid())
  questionNumber        Int                   @unique
  section               String
  prompt                String
  type                  String
  isActive              Boolean               @default(true)
  order                 Int
  
  options               QuestionOption[]
  
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  
  @@index([questionNumber])
  @@index([order])
}

model QuestionOption {
  id                    String                @id @default(uuid())
  questionId            String
  question              Question              @relation(fields: [questionId], references: [id], onDelete: Cascade)
  
  optionKey             String
  text                  String
  
  traitImpacts          Json
  
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  
  @@unique([questionId, optionKey])
}